{% extends "base.html" %}
{% block title %}Moderation Dashboard - Pupero{% endblock %}

{% block content %}
<div class="container">
    <h1>Moderation Dashboard</h1>
    
    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Pending Reports</h3>
            <span class="stat-number" id="pending-reports">{{ stats.pending_reports or 0 }}</span>
        </div>
        <div class="stat-card">
            <h3>Open Disputes</h3>
            <span class="stat-number" id="pending-disputes">{{ stats.pending_disputes or 0 }}</span>
        </div>
        <div class="stat-card">
            <h3>Pending Appeals</h3>
            <span class="stat-number" id="pending-appeals">{{ stats.pending_appeals or 0 }}</span>
        </div>
        <div class="stat-card">
            <h3>Queue Size</h3>
            <span class="stat-number" id="queue-size">{{ stats.queue_size or 0 }}</span>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Active Bans</h3>
            <span class="stat-number warning">{{ stats.active_bans or 0 }}</span>
        </div>
        <div class="stat-card">
            <h3>Active Mutes</h3>
            <span class="stat-number">{{ stats.active_mutes or 0 }}</span>
        </div>
        <div class="stat-card">
            <h3>Active Suspensions</h3>
            <span class="stat-number">{{ stats.active_suspensions or 0 }}</span>
        </div>
        <div class="stat-card">
            <h3>Today's Actions</h3>
            <span class="stat-number success">{{ stats.today_actions or 0 }}</span>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="section">
        <h2>Quick Actions</h2>
        <div class="button-group">
            <a href="{{ url_for('moderation_reports') }}" class="btn btn-primary">View Reports</a>
            <a href="{{ url_for('moderation_disputes') }}" class="btn btn-primary">View Disputes</a>
            <a href="{{ url_for('moderation_appeals') }}" class="btn btn-primary">View Appeals</a>
            <a href="{{ url_for('moderation_queue') }}" class="btn btn-secondary">Moderation Queue</a>
            <a href="{{ url_for('moderation_users') }}" class="btn btn-secondary">Search Users</a>
            {% if is_admin %}
            <a href="{{ url_for('moderation_audit_logs') }}" class="btn btn-warning">Audit Logs</a>
            {% endif %}
        </div>
    </div>

    <!-- Moderation Queue -->
    <div class="section">
        <h2>Moderation Queue</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>ID</th>
                    <th>Priority</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="queue-items">
                {% for item in queue_items %}
                <tr>
                    <td><span class="badge badge-{{ item.item_type }}">{{ item.item_type }}</span></td>
                    <td>#{{ item.item_id }}</td>
                    <td>{{ item.priority }}</td>
                    <td>{{ item.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="claimItem({{ item.id }})">Claim</button>
                        <a href="{{ url_for('moderation_view_item', item_type=item.item_type, item_id=item.item_id) }}" class="btn btn-sm btn-secondary">View</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center">No items in queue</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Recent Actions -->
    <div class="section">
        <h2>Recent Actions</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Action</th>
                    <th>Target User</th>
                    <th>Moderator</th>
                    <th>Reason</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for action in recent_actions %}
                <tr>
                    <td><span class="badge badge-{{ action.action_type }}">{{ action.action_type }}</span></td>
                    <td>User #{{ action.target_user_id }}</td>
                    <td>Mod #{{ action.moderator_user_id }}</td>
                    <td>{{ action.reason[:50] }}{% if action.reason|length > 50 %}...{% endif %}</td>
                    <td>{{ action.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center">No recent actions</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: #1a1a2e;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    border: 1px solid #333;
}

.stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #888;
}

.stat-number {
    font-size: 36px;
    font-weight: bold;
    color: #4CAF50;
}

.stat-number.warning {
    color: #ff9800;
}

.stat-number.success {
    color: #4CAF50;
}

.section {
    background: #1a1a2e;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #333;
}

.section h2 {
    margin-top: 0;
    border-bottom: 1px solid #333;
    padding-bottom: 10px;
}

.button-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.btn {
    padding: 10px 20px;
    border-radius: 4px;
    text-decoration: none;
    font-weight: bold;
    cursor: pointer;
    border: none;
    display: inline-block;
}

.btn-primary {
    background: #4CAF50;
    color: white;
}

.btn-secondary {
    background: #2196F3;
    color: white;
}

.btn-warning {
    background: #ff9800;
    color: white;
}

.btn-danger {
    background: #f44336;
    color: white;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 12px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th,
.data-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #333;
}

.data-table th {
    background: #16213e;
    font-weight: bold;
}

.data-table tr:hover {
    background: #16213e;
}

.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.badge-report { background: #ff9800; color: white; }
.badge-dispute { background: #f44336; color: white; }
.badge-appeal { background: #2196F3; color: white; }
.badge-warn { background: #ff9800; color: white; }
.badge-mute { background: #9c27b0; color: white; }
.badge-ban { background: #f44336; color: white; }
.badge-suspend { background: #e91e63; color: white; }

.text-center {
    text-align: center;
}
</style>

<script>
async function claimItem(queueId) {
    try {
        const response = await fetch(`/api/moderation/queue/${queueId}/claim`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const data = await response.json();
        if (data.status === 'ok') {
            window.location.href = `/moderation/${data.item_type}/${data.item_id}`;
        } else {
            alert('Failed to claim item');
        }
    } catch (error) {
        alert('Error claiming item: ' + error.message);
    }
}

// Auto-refresh stats every 30 seconds
setInterval(async () => {
    try {
        const response = await fetch('/api/moderation/dashboard');
        const data = await response.json();
        document.getElementById('pending-reports').textContent = data.pending_reports;
        document.getElementById('pending-disputes').textContent = data.pending_disputes;
        document.getElementById('pending-appeals').textContent = data.pending_appeals;
        document.getElementById('queue-size').textContent = data.queue_size;
    } catch (error) {
        console.error('Failed to refresh stats:', error);
    }
}, 30000);
</script>
{% endblock %}
