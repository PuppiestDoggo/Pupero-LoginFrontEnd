{% extends 'base.html' %}
{% set hide_header = True %}
{% block title %}Login{% endblock %}
{%block css %}
<link rel="stylesheet" href="{{url_for('static', filename='css/pages/login.css') }}">
{% endblock %}
{% block content %}
    {% set current_stage = stage or 'identifier' %}
    <div class="login-grid">
        <div class="login-left">
            <img class="login-logo" src="{{ url_for('static', filename='login_logo.png') }}" alt="Logo" onerror="this.style.display='none'">
        </div>

        <div class="login-right">
            <h1>Login</h1>

            {% if current_stage == 'identifier' %}
            <form method="post" class="login-form" aria-label="Enter username or email">
                <input type="hidden" name="stage" value="identifier">

                <div class="form-group">
                    <label>Username or Email:<br>
                        <input type="text" name="identifier" value="{{ identifier or '' }}" required autocomplete="username">
                    </label>
                </div>

                <div class="form-group">
                    <label><input type="checkbox" name="remember_me" value="yes" {% if remember_me %}checked{% endif %}> Remember me</label>
                </div>

                <div class="login-actions">
                    <button type="submit" class="btn-primary">Continue</button>
                </div>
            </form>

            {% elif current_stage == 'password' %}
            <form method="post" class="login-form" aria-label="Enter password">
                <input type="hidden" name="stage" value="password">
                <input type="hidden" name="identifier" value="{{ identifier }}">

                <div class="form-group">
                    <p class="login-info">Signing in as <strong>{{ identifier }}</strong></p>
                </div>

                <div class="form-group">
                    <label>Password:<br>
                        <input type="password" name="password" required autocomplete="current-password">
                    </label>
                </div>

                <div class="form-group">
                    <label><input type="checkbox" name="remember_me" value="yes" {% if remember_me %}checked{% endif %}> Remember me</label>
                </div>
                <div class="login-actions">
                    <button type="submit" class="btn-primary">Continue</button>
                    <button type="submit" name="stage" value="identifier" formaction="{{ url_for('login') }}" class="btn-secondary">Back</button>
                </div>
            </form>

            {% elif current_stage == 'totp' %}
            <form method="post" class="login-form" aria-label="Enter 2FA code">
                <input type="hidden" name="stage" value="totp">
                <input type="hidden" name="identifier" value="{{ identifier }}">
                <input type="hidden" name="password_cached" value="{{ password_cached }}">
                <div class="form-group">
                    <p class="login-info">2FA required for <strong>{{ identifier }}</strong></p>
                </div>
                <div class="form-group">
                    <label>Authenticator code:<br>
                        <input type="text" name="totp" inputmode="numeric" pattern="[0-9]*" maxlength="8" placeholder="123456" required>
                    </label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" name="remember_me" value="yes" {% if remember_me %}checked{% endif %}> Remember me</label>
                </div>
                <div class="login-actions">
                    <button type="submit" class="btn-primary">Verify & Sign in</button>
                    <button type="submit" name="stage" value="password" formaction="{{ url_for('login') }}" class="btn-secondary">Back</button>
                </div>
            </form>
            {% elif current_stage == 'success' %}
            <div class="login-success">
                <strong>You're signed in.</strong>
                <p class="login-info">You can now proceed:</p>

                <div class="login-actions">
                    <a href="{{ url_for('profile') }}" class="btn-primary">Go to Profile</a>
                    <a href="{{ url_for('offers') }}" class="btn-secondary">Browse Offers</a>
                    <a href="{{ url_for('home') }}" class="btn-secondary">Home</a>
                </div>
                <p class="login-note">
                    Note: navigation bar will reflect your session on the next page you open.
                </p>
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}
