{% extends 'base.html' %}
{% block title %}Admin{% endblock %}
{% block content %}
<h1>Admin</h1>
<p>This page requires an administrator account.</p>

<h2>Join any Matrix conversation</h2>
<form method="get" action="{{ element_base }}" target="_blank" rel="noopener" style="display:flex;gap:6px;max-width:600px;align-items:center;">
  <label style="flex:1">Room ID or Alias
    <input type="text" name="room" placeholder="!room:server or #alias:server" style="width:100%" oninput="document.getElementById('joinLink').href='{{ element_base }}'+this.value;">
  </label>
  <a id="joinLink" class="button" href="{{ element_base }}" target="_blank" rel="noopener" style="padding:6px 10px;border:1px solid #ccc;border-radius:4px;text-decoration:none;">Open</a>
</form>

<hr>
<h2>Users</h2>
{% if users and users|length > 0 %}
<table border="1" cellpadding="6" cellspacing="0">
  <thead>
    <tr><th>ID</th><th>Email</th><th>Username</th><th>Role</th><th>Disabled</th><th>Created</th><th>Actions</th></tr>
  </thead>
  <tbody>
  {% for u in users %}
    <tr>
      <td>{{ u.id }}</td>
      <td>{{ u.email }}</td>
      <td>{{ u.username }}</td>
      <td>{{ u.role }}</td>
      <td>{{ 'yes' if u.is_disabled else 'no' }}</td>
      <td>{{ u.created_at }}</td>
      <td>
        <form method="post" style="display:inline">
          <input type="hidden" name="user_id" value="{{ u.id }}">
          {% if u.is_disabled %}
            <input type="hidden" name="action" value="enable">
            <button type="submit">Enable</button>
          {% else %}
            <input type="hidden" name="action" value="disable">
            <button type="submit">Disable</button>
          {% endif %}
        </form>
        <form method="post" style="display:inline">
          <input type="hidden" name="user_id" value="{{ u.id }}">
          <input type="hidden" name="action" value="set_role">
          <select name="role">
            <option value="user" {% if u.role=='user' %}selected{% endif %}>user</option>
            <option value="admin" {% if u.role=='admin' %}selected{% endif %}>admin</option>
            <option value="superadmin" {% if u.role=='superadmin' %}selected{% endif %}>superadmin</option>
          </select>
          <button type="submit">Change role</button>
        </form>
        <form method="post" style="display:inline">
          <input type="hidden" name="user_id" value="{{ u.id }}">
          <input type="hidden" name="action" value="logout">
          <button type="submit">Force logout</button>
        </form>
        <details style="display:inline-block;margin-left:6px;">
          <summary>Reset password</summary>
          <form method="post" style="display:flex;gap:6px;align-items:center;margin-top:4px;">
            <input type="hidden" name="user_id" value="{{ u.id }}">
            <input type="hidden" name="action" value="reset_password">
            <input type="password" name="new_password" placeholder="New password (min 6)" required>
            <button type="submit">Set</button>
          </form>
        </details>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% else %}
<p>No users found.</p>
{% endif %}

<hr>
<h2>Balances</h2>
<form method="get" action="{{ url_for('admin_balance') }}" style="display:flex;gap:8px;align-items:center;">
  <label>User ID <input type="number" name="user_id" min="1" value="{{ last_user_id or '' }}"></label>
  <button type="submit">View balance</button>
</form>
{% if balance %}
  <div style="margin-top:8px;">
    <div><strong>User {{ balance.user_id }}</strong></div>
    <div>Fake XMR: {{ balance.fake_xmr }}</div>
    <div>Real XMR: {{ balance.real_xmr }}</div>
    <form method="post" action="{{ url_for('admin_balance') }}" style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap;">
      <input type="hidden" name="user_id" value="{{ balance.user_id }}">
      <label>Amount XMR <input type="number" step="0.0000000001" min="0" name="amount_xmr" required></label>
      <label>Kind
        <select name="kind"><option value="fake">fake</option><option value="real">real</option></select>
      </label>
      <button type="submit" name="op" value="increase">Increase</button>
      <button type="submit" name="op" value="decrease">Decrease</button>
    </form>
  </div>
{% endif %}

{% endblock %}
