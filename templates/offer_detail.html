{% extends 'base.html' %}
{% block title %}Offer {{ offer.id }}{% endblock %}
{% block content %}
<h1>{{ offer.title }}</h1>

{% set side = (offer_side or ad.side)|lower %}
<div style="margin:8px 0;padding:8px;border:1px solid #ddd;background:#f9f9f9;">
  {% if side == 'sell' %}
    <span style="display:inline-block;padding:2px 8px;border-radius:12px;background:#ffecb3;color:#8a6d3b;font-weight:600;">SELL XMR</span>
    <span style="margin-left:8px;">Offer owner is the <strong>Seller of XMR</strong>. If you start a trade, <strong>you will BUY XMR</strong> and pay fiat externally.</span>
  {% else %}
    <span style="display:inline-block;padding:2px 8px;border-radius:12px;background:#c8e6c9;color:#256029;font-weight:600;">BUY XMR</span>
    <span style="margin-left:8px;">Offer owner is the <strong>Buyer of XMR</strong>. If you start a trade, <strong>you will SELL XMR</strong> and receive fiat externally.</span>
  {% endif %}
</div>

<table border="1" cellpadding="6" cellspacing="0">
  <tr><th align="left">Status</th><td>{{ offer.status }}</td></tr>
  <tr><th align="left">Offer owner</th><td>{{ offer.seller_name or 'unknown' }}</td></tr>
  <tr><th align="left">Side</th><td>{{ side|upper }} XMR</td></tr>
  <tr><th align="left">Crypto</th><td>{{ ad.crypto }}</td></tr>
  <tr><th align="left">Fiat</th><td>{{ ad.fiat }}</td></tr>
  <tr><th align="left">Price per XMR</th><td>{{ price_per_xmr }} {{ ad.fiat }}</td></tr>
  <tr><th align="left">Price setting</th><td>{{ ad.price_mode }}{% if ad.price_mode=='market' %} (margin {{ ad.margin }}%){% elif ad.price_mode=='fixed' %} (fixed {{ ad.fixed_price }} {{ ad.fiat }} / XMR){% elif ad.price_mode=='equation' %} (equation: {{ ad.pricing_equation or 'placeholder' }}){% endif %}</td></tr>
  <tr><th align="left">Payment method</th><td>{{ ad.payment_method or (ad.payment_methods|first) }}</td></tr>
  <tr><th align="left">Limits</th><td>{{ ad.min_limit }} - {{ ad.max_limit }} {{ ad.fiat }}</td></tr>
  <tr><th align="left">Requirements</th><td>phone={{ ad.req_phone }}, id={{ ad.req_id }}</td></tr>
  <tr><th align="left">Schedule</th><td>{{ ad.schedule_human }}</td></tr>
  <tr><th align="left">Promo</th><td>{{ ad.promo_text }}</td></tr>
  <tr><th align="left">Trade conditions</th><td>{{ ad.trade_conditions }}</td></tr>
</table>

{% if self_trade_block %}
<h2>Start Trade</h2>
<p style="color:#b00;">You cannot start a trade with yourself.</p>
<p><a href="{{ url_for('offers') }}">Back to offers</a></p>
{% else %}
<h2>Start Trade â€” {% if side == 'sell' %}You will BUY XMR{% else %}You will SELL XMR{% endif %}</h2>
<form method="post" action="{{ url_for('trade_start', offer_id=offer.id) }}" style="display:grid;gap:8px;max-width:640px;grid-template-columns:repeat(2, minmax(200px,1fr));align-items:end;">
  <div style="grid-column:1/3;">
    <strong>How much {{ ad.fiat }} / XMR would you like to trade?</strong>
  </div>
  <label>{{ ad.fiat }} amount
    <input type="number" step="0.01" min="0" name="fiat_amount" id="fiat_amount">
  </label>
  <label>XMR amount
    <input type="number" step="0.0000000001" min="0" name="xmr_amount" id="xmr_amount">
  </label>
  <label style="grid-column:1/3">Payment method
    <select name="payment_choice">
      {% for pm in ad.payment_methods %}
        <option value="{{ pm }}">{{ pm }}</option>
      {% endfor %}
    </select>
  </label>
  <label style="grid-column:1/3">Message to counterparty (optional)
    <textarea name="message" rows="3" placeholder="Hi, I'd like to trade..."></textarea>
  </label>
  <div style="grid-column:1/3">
    <button type="submit">Start Trade</button>
    <a href="{{ url_for('offers') }}" style="margin-left:12px;">Back to offers</a>
  </div>
</form>
<script>
  (function(){
    const price = {{ price_per_xmr | tojson }}; // {{ ad.fiat }} per 1 XMR
    const fiat = document.getElementById('fiat_amount');
    const xmr = document.getElementById('xmr_amount');
    let lock = false;
    function round2(n){ return Math.round(n * 100) / 100; }
    function round4(n){ return Math.round(n * 10000) / 10000; }
    function onFiat(){
      if(lock) return; lock = true;
      const v = parseFloat(fiat.value);
      if(!isNaN(v) && v > 0 && price > 0){ xmr.value = round4(v / price); } else { xmr.value = ''; }
      lock = false;
    }
    function onXmr(){
      if(lock) return; lock = true;
      const v = parseFloat(xmr.value);
      if(!isNaN(v) && v > 0 && price > 0){ fiat.value = round2(v * price); } else { fiat.value = ''; }
      lock = false;
    }
    fiat.addEventListener('input', onFiat);
    xmr.addEventListener('input', onXmr);
  })();
</script>
{% endif %}
{% endblock %}
